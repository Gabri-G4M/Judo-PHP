version: 2.1

commands:
  test:
    parameters:
      php-version:
        type: string
    steps:
      - checkout
      - restore_cache:
          keys:
            - vendor-<< parameters.php-version >>-{{ checksum "composer.json" }}
      - run: composer install -n --prefer-dist
      - save_cache:
          key: vendor-<< parameters.php-version >>-{{ checksum "composer.json" }}
          paths:
            - ./vendor
      - run: php -r "printf('PHP %s', phpversion());"
      - run: ./vendor/bin/phpunit --stop-on-failure

executors:
  php:
    parameters:
      php-version:
        type: string
    docker:
      - image: circleci/php:<< parameters.php-version >>

jobs:
  code-analysis:
    executor:
      name: php
      php-version: "7.3"
    steps:
      - checkout
      - restore_cache:
          keys:
            - vendor-7.3-{{ checksum "composer.json" }}
      - run: composer install -n --prefer-dist
      - run: ./vendor/bin/phpcs --standard=.phpcs.xml src
      - run: ./vendor/bin/phpcs --standard=.phpcs.xml spec --exclude="PSR1.Methods.CamelCapsMethodName"
      - run: ./vendor/bin/phpcs --standard=.phpcs.xml tests
      - run: ./vendor/bin/phpspec run
  test-php56:
    executor:
      name: php
      php-version: "5.6"
    steps:
      - test:
          php-version: "5.6"
  test-php70:
    executor:
      name: php
      php-version: "7.0"
    steps:
      - test:
          php-version: "7.0"
  test-php71:
    executor:
      name: php
      php-version: "7.1"
    steps:
      - test:
          php-version: "7.1"
  test-php72:
    executor:
      name: php
      php-version: "7.2"
    steps:
      - test:
          php-version: "7.2"
  test-php73:
    executor:
      name: php
      php-version: "7.3"
    steps:
      - test:
          php-version: "7.3"

workflows:
  version: 2
  test:
    jobs:
      - code-analysis
      - test-php56
      - test-php70
      - test-php71
      - test-php72
      - test-php73
